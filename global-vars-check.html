<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å±€å˜é‡æ±¡æŸ“æ£€æµ‹å·¥å…·</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .var-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .system-var { background: #e8f5e8; }
        .custom-var { background: #fff3cd; }
        .potential-pollution { background: #f8d7da; }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .filter-buttons {
            margin: 10px 0;
        }
        
        .hidden { display: none; }
        
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <h1>å…¨å±€å˜é‡æ±¡æŸ“æ£€æµ‹å·¥å…·</h1>
    <p>æ­¤å·¥å…·ç”¨äºæ£€æµ‹é¡µé¢ä¸­çš„å…¨å±€å˜é‡ï¼Œè¯†åˆ«æ½œåœ¨çš„å‘½åç©ºé—´æ±¡æŸ“é—®é¢˜ã€‚</p>
    
    <div class="section">
        <h2>æ£€æµ‹ç»Ÿè®¡</h2>
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalVars">0</div>
                <div>æ€»å˜é‡æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="systemVars">0</div>
                <div>ç³»ç»Ÿå˜é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="customVars">0</div>
                <div>è‡ªå®šä¹‰å˜é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pollutionVars">0</div>
                <div>æ½œåœ¨æ±¡æŸ“</div>
            </div>
        </div>
        
        <button onclick="scanGlobalVars()">æ‰«æå…¨å±€å˜é‡</button>
        <button onclick="exportReport()">å¯¼å‡ºæŠ¥å‘Š</button>
    </div>
    
    <div class="section">
        <h2>å˜é‡åˆ—è¡¨</h2>
        <div class="filter-buttons">
            <button onclick="filterVars('all')" class="active">å…¨éƒ¨</button>
            <button onclick="filterVars('system')">ç³»ç»Ÿå˜é‡</button>
            <button onclick="filterVars('custom')">è‡ªå®šä¹‰å˜é‡</button>
            <button onclick="filterVars('pollution')">æ½œåœ¨æ±¡æŸ“</button>
        </div>
        <div id="varsList"></div>
    </div>
    
    <div class="section">
        <h2>å‘½åç©ºé—´ä½¿ç”¨æƒ…å†µ</h2>
        <div id="namespaceInfo"></div>
    </div>
    
    <div class="section">
        <h2>å»ºè®®</h2>
        <div id="suggestions"></div>
    </div>

    <script>
        let globalVars = {};
        let systemVars = new Set();
        let currentFilter = 'all';
        
        // è®°å½•é¡µé¢åŠ è½½æ—¶çš„ç³»ç»Ÿå˜é‡
        function recordSystemVars() {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            const cleanWindow = iframe.contentWindow;
            for (let prop in cleanWindow) {
                systemVars.add(prop);
            }
            
            document.body.removeChild(iframe);
        }
        
        function scanGlobalVars() {
            globalVars = {};
            
            // æ‰«æwindowå¯¹è±¡çš„æ‰€æœ‰å±æ€§
            for (let prop in window) {
                try {
                    const value = window[prop];
                    const type = typeof value;
                    
                    globalVars[prop] = {
                        type: type,
                        value: value,
                        isSystem: systemVars.has(prop),
                        isFunction: type === 'function',
                        isObject: type === 'object' && value !== null,
                        constructor: value?.constructor?.name || 'Unknown'
                    };
                } catch (e) {
                    globalVars[prop] = {
                        type: 'error',
                        value: '[Access Denied]',
                        isSystem: systemVars.has(prop),
                        error: e.message
                    };
                }
            }
            
            updateStats();
            displayVars();
            checkNamespace();
            generateSuggestions();
        }
        
        function updateStats() {
            const total = Object.keys(globalVars).length;
            const system = Object.values(globalVars).filter(v => v.isSystem).length;
            const custom = total - system;
            const pollution = identifyPollution().length;
            
            document.getElementById('totalVars').textContent = total;
            document.getElementById('systemVars').textContent = system;
            document.getElementById('customVars').textContent = custom;
            document.getElementById('pollutionVars').textContent = pollution;
        }
        
        function identifyPollution() {
            const pollutionPatterns = [
                /^[a-z]$/, // å•å­—æ¯å˜é‡
                /^temp/, // ä¸´æ—¶å˜é‡
                /^test/, // æµ‹è¯•å˜é‡
                /^debug/, // è°ƒè¯•å˜é‡
                /^_$/, // å•ä¸‹åˆ’çº¿
                /^[A-Z]{2,}$/, // å…¨å¤§å†™çŸ­å˜é‡
            ];
            
            const commonPollutants = [
                'i', 'j', 'k', 'x', 'y', 'z', 'a', 'b', 'c',
                'temp', 'tmp', 'test', 'debug', 'foo', 'bar', 'baz'
            ];
            
            return Object.keys(globalVars).filter(name => {
                if (globalVars[name].isSystem) return false;
                
                return pollutionPatterns.some(pattern => pattern.test(name)) ||
                       commonPollutants.includes(name.toLowerCase());
            });
        }
        
        function displayVars() {
            const container = document.getElementById('varsList');
            const vars = Object.keys(globalVars).sort();
            const pollution = identifyPollution();
            
            container.innerHTML = vars.map(name => {
                const info = globalVars[name];
                let className = 'var-item ';
                
                if (info.isSystem) {
                    className += 'system-var';
                } else if (pollution.includes(name)) {
                    className += 'potential-pollution';
                } else {
                    className += 'custom-var';
                }
                
                const valuePreview = getValuePreview(info.value);
                
                return `
                    <div class="${className}" data-category="${getCategory(name, info)}">
                        <strong>${name}</strong> 
                        <span style="color: #666;">(${info.type})</span>
                        ${info.constructor !== 'Unknown' ? `<span style="color: #888;">[${info.constructor}]</span>` : ''}
                        <br>
                        <small style="color: #555;">${valuePreview}</small>
                    </div>
                `;
            }).join('');
        }
        
        function getCategory(name, info) {
            if (info.isSystem) return 'system';
            if (identifyPollution().includes(name)) return 'pollution';
            return 'custom';
        }
        
        function getValuePreview(value) {
            if (value === null) return 'null';
            if (value === undefined) return 'undefined';
            if (typeof value === 'string') {
                return `"${value.length > 50 ? value.substring(0, 50) + '...' : value}"`;
            }
            if (typeof value === 'function') {
                const funcStr = value.toString();
                const firstLine = funcStr.split('\n')[0];
                return firstLine.length > 60 ? firstLine.substring(0, 60) + '...' : firstLine;
            }
            if (typeof value === 'object') {
                try {
                    const keys = Object.keys(value);
                    return `{${keys.slice(0, 3).join(', ')}${keys.length > 3 ? '...' : ''}}`;
                } catch (e) {
                    return '[Object]';
                }
            }
            return String(value);
        }
        
        function filterVars(category) {
            currentFilter = category;
            const items = document.querySelectorAll('.var-item');
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            items.forEach(item => {
                if (category === 'all' || item.dataset.category === category) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }
        
        function checkNamespace() {
            const container = document.getElementById('namespaceInfo');
            const hasXPK = typeof window.XPK !== 'undefined';
            const xpkComponents = hasXPK ? Object.keys(window.XPK.components || {}) : [];
            const xpkUtils = hasXPK ? Object.keys(window.XPK.utils || {}) : [];
            
            container.innerHTML = `
                <h3>XPKå‘½åç©ºé—´</h3>
                <p><strong>çŠ¶æ€:</strong> ${hasXPK ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}</p>
                ${hasXPK ? `
                    <p><strong>æ³¨å†Œç»„ä»¶:</strong> ${xpkComponents.length > 0 ? xpkComponents.join(', ') : 'æ— '}</p>
                    <p><strong>å·¥å…·å‡½æ•°:</strong> ${xpkUtils.length > 0 ? xpkUtils.join(', ') : 'æ— '}</p>
                ` : ''}
                
                <h3>å…¶ä»–å‘½åç©ºé—´</h3>
                <ul>
                    ${['jQuery', '$', 'React', 'Vue', 'Angular'].map(ns => 
                        `<li>${ns}: ${typeof window[ns] !== 'undefined' ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</li>`
                    ).join('')}
                </ul>
            `;
        }
        
        function generateSuggestions() {
            const container = document.getElementById('suggestions');
            const pollution = identifyPollution();
            const customVars = Object.keys(globalVars).filter(name => !globalVars[name].isSystem);
            const hasXPK = typeof window.XPK !== 'undefined';
            
            let suggestions = [];
            
            if (pollution.length > 0) {
                suggestions.push(`ğŸš¨ å‘ç° ${pollution.length} ä¸ªæ½œåœ¨çš„å…¨å±€å˜é‡æ±¡æŸ“: ${pollution.join(', ')}`);
                suggestions.push('å»ºè®®å°†è¿™äº›å˜é‡ç§»åˆ°é€‚å½“çš„å‘½åç©ºé—´ä¸­æˆ–ä½¿ç”¨IIFEåŒ…è£…ã€‚');
            }
            
            if (customVars.length > 10) {
                suggestions.push(`âš ï¸ è‡ªå®šä¹‰å…¨å±€å˜é‡è¿‡å¤š (${customVars.length} ä¸ª)ï¼Œå»ºè®®ä½¿ç”¨å‘½åç©ºé—´ç®¡ç†ã€‚`);
            }
            
            if (!hasXPK) {
                suggestions.push('ğŸ’¡ å»ºè®®å¯ç”¨XPKå‘½åç©ºé—´ç³»ç»Ÿæ¥ç®¡ç†å…¨å±€å˜é‡ã€‚');
            }
            
            if (customVars.some(name => name.startsWith('xpk') || name.startsWith('Xpk'))) {
                suggestions.push('âœ… æ£€æµ‹åˆ°ä½¿ç”¨äº†xpkå‰ç¼€çš„å˜é‡ï¼Œè¿™æ˜¯è‰¯å¥½çš„å‘½åå®è·µã€‚');
            }
            
            if (suggestions.length === 0) {
                suggestions.push('âœ… å…¨å±€å˜é‡ä½¿ç”¨æƒ…å†µè‰¯å¥½ï¼Œæœªå‘ç°æ˜æ˜¾é—®é¢˜ã€‚');
            }
            
            container.innerHTML = suggestions.map(s => `<p>${s}</p>`).join('');
        }
        
        function exportReport() {
            const report = {
                timestamp: new Date().toISOString(),
                url: window.location.href,
                stats: {
                    total: Object.keys(globalVars).length,
                    system: Object.values(globalVars).filter(v => v.isSystem).length,
                    custom: Object.values(globalVars).filter(v => !v.isSystem).length,
                    pollution: identifyPollution().length
                },
                pollution: identifyPollution(),
                customVars: Object.keys(globalVars).filter(name => !globalVars[name].isSystem),
                namespaceStatus: {
                    hasXPK: typeof window.XPK !== 'undefined',
                    xpkComponents: typeof window.XPK !== 'undefined' ? Object.keys(window.XPK.components || {}) : [],
                    xpkUtils: typeof window.XPK !== 'undefined' ? Object.keys(window.XPK.utils || {}) : []
                }
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `global-vars-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            recordSystemVars();
            scanGlobalVars();
        });
        
        // æ·»åŠ CSS for active button
        const style = document.createElement('style');
        style.textContent = `
            .filter-buttons button.active {
                background: #28a745;
            }
            .filter-buttons button.active:hover {
                background: #218838;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>