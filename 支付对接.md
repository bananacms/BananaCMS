# 支付对接文档

## 支持的支付方式

| 支付方式 | 协议类型 | 金额单位 | 说明 |
|---------|---------|---------|------|
| MCH易支付 | epay | 元 | 最常见的第三方支付协议 |
| 熊熊支付 | xiongxiong | 分 | 需配置渠道编号 |
| 直连支付 | zhilian | 元 | 直连支付协议 |
| USDT/TRC20 | - | USDT | 链上直接收款 |

---

## 一、MCH易支付配置

易支付是最常见的第三方支付接口协议，兼容大多数支付平台。

### 后台配置

1. 进入 `后台 → 支付通道管理 → 添加通道`
2. 填写以下信息：

| 字段 | 说明 | 示例 |
|-----|------|------|
| 通道编码 | 唯一标识 | `mch_pay` |
| 通道名称 | 显示名称 | `MCH易支付` |
| 通道类型 | 选择协议 | `易支付协议 (MCH)` |
| 网关地址 | 支付网关URL | `https://pay.example.com/submit.php` |
| 查询地址 | 订单查询URL | `https://pay.example.com/api.php` |
| 商户ID | 平台分配的PID | `1001` |
| 商户密钥 | 平台分配的KEY | `xxxxxxxxxxxxxxxx` |
| 支持方式 | 勾选支付宝/微信 | ☑ 支付宝 ☑ 微信 |

### 回调地址

在支付平台后台配置回调地址：
```
异步通知: https://你的域名/api?action=pay.notify
同步跳转: https://你的域名/user/pay/result
```

### 签名规则

- 参数按ASCII排序
- 空值不参与签名
- 签名方式：`MD5(参数串 + 密钥)`

---

## 二、熊熊支付配置

熊熊支付金额单位为分，签名使用小写MD5。

### 后台配置

1. 进入 `后台 → 支付通道管理 → 添加通道`
2. 填写以下信息：

| 字段 | 说明 | 示例 |
|-----|------|------|
| 通道编码 | 唯一标识 | `xiongxiong_alipay` |
| 通道名称 | 显示名称 | `熊熊支付` |
| 通道类型 | 选择协议 | `熊熊支付` |
| 网关地址 | 支付网关URL | `http://api.pigpay.vip:8585/go/gateway.go` |
| 查询地址 | 订单查询URL | `http://api.pigpay.vip:8585/go/query.go` |
| 商户ID | 平台分配的PID | `10001` |
| 商户密钥 | 平台分配的KEY | `xxxxxxxxxxxxxxxx` |
| 渠道编号(cid) | 支付渠道编号 | `1` |
| 扩展参数(eparam) | 特殊配置，一般留空 | `` |

### 渠道编号参考

从商户后台获取具体的渠道编号，常见如：
- `1` - 支付宝
- `2` - 微信

### 回调IP白名单

需要在服务器防火墙放行以下IP：
```
47.57.70.158
47.57.185.68
47.57.180.218
47.57.8.88
47.57.8.7
47.57.187.77
8.212.22.186
```

### 签名规则

**下单签名（ASCII排序）：**
```
MD5("amount=&burl=&cid=&eparam=&ip=&nurl=&oid=&pid=&stype=&type=&uid=&key=密钥")
```
- 空值也参与签名
- 结果小写

**回调签名（固定顺序）：**
```
MD5("pid=&cid=&oid=&sid=&uid=&amount=&ramount=&stime=&code=&key=密钥")
```
- 不排序，按固定顺序
- 结果小写

### 状态码说明

| 状态码 | 说明 |
|-------|------|
| 101 | 成功 |
| 104 | 签名错误 |
| 109 | 订单号重复 |
| 116 | 金额错误 |
| 122 | 渠道维护中 |

---

## 三、直连支付配置

直连支付协议，签名使用大写MD5。

### 后台配置

1. 进入 `后台 → 支付通道管理 → 添加通道`
2. 填写以下信息：

| 字段 | 说明 | 示例 |
|-----|------|------|
| 通道编码 | 唯一标识 | `zhilian_alipay` |
| 通道名称 | 显示名称 | `直连支付` |
| 通道类型 | 选择协议 | `直连支付` |
| 网关地址 | 支付网关URL | `https://api.xxx.com/pay` |
| 商户ID | 平台分配的商户号 | `M10001` |
| 商户密钥 | 平台分配的密钥 | `xxxxxxxxxxxxxxxx` |
| 渠道代码 | 支付渠道标识 | `alipay_h5` |

### 渠道代码参考

| 渠道代码 | 说明 |
|---------|------|
| alipay_h5 | 支付宝H5 |
| alipay_scan | 支付宝扫码 |
| wxpay_h5 | 微信H5 |
| wxpay_scan | 微信扫码 |

### 签名规则

- 参数按ASCII排序
- 空值不参与签名
- 签名方式：`MD5(参数串 + 密钥)` 转大写

---

## 四、USDT/TRC20 配置

USDT支付通过TRC20网络直接收款，系统自动轮询检测到账。

### 后台配置

1. 进入 `后台 → 支付通道管理 → USDT配置`
2. 填写以下信息：

| 字段 | 说明 | 示例 |
|-----|------|------|
| 启用USDT支付 | 开关 | ☑ 启用 |
| USDT收款地址 | TRC20钱包地址 | `TXxxxxxxxxxxxxxxxxxxxxxxxxxxxx` |
| TronGrid API Key | API密钥 | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| 金额锁定时间 | 订单有效期(秒) | `1800` |

### 获取 TronGrid API Key

1. 访问 https://www.trongrid.io/
2. 注册账号并登录
3. 创建新项目获取 API Key

### 工作原理

1. 用户选择USDT支付时，系统生成唯一金额（精确到4位小数）
2. 用户转账指定金额到收款地址
3. 系统通过TronGrid API轮询检测到账
4. 匹配金额和时间后自动完成订单

### 注意事项

- 收款地址必须是TRC20网络的USDT地址
- 金额锁定期间，同一金额不会分配给其他订单
- 建议锁定时间设置为1800秒（30分钟）
- 用户也可点击"我已付款"手动触发检测

---

## 通用配置

### 回调地址配置

所有支付方式使用统一的回调地址：

```
异步通知URL: https://你的域名/api?action=pay.notify
同步跳转URL: https://你的域名/user/pay/result
```

### 配置文件

支付配置文件位于 `config/payment.php`：

```php
return [
    'notify_url' => 'https://你的域名/api?action=pay.notify',
    'return_url' => 'https://你的域名/user/pay/result',
    'order' => [
        'no_prefix' => 'XPK',      // 订单号前缀
        'expire_time' => 1800,     // 订单过期时间(秒)
    ],
    'usdt' => [
        'enabled' => true,
        'address' => 'TXxxxx...',
        'tron_api_key' => 'xxxxx',
        'lock_time' => 1800,
    ],
];
```

### 测试支付

1. 添加通道后，先设置为"禁用"状态
2. 使用小金额测试下单和回调
3. 确认无误后再启用通道

### 常见问题

**Q: 支付后没有回调？**
- 检查回调地址是否正确配置
- 检查服务器是否能被支付平台访问
- 查看服务器日志排查错误

**Q: 签名验证失败？**
- 检查商户密钥是否正确
- 检查是否选择了正确的协议类型
- 熊熊支付注意金额单位是分

**Q: USDT支付检测不到？**
- 检查TronGrid API Key是否有效
- 确认收款地址是TRC20网络
- 检查转账金额是否精确匹配
