# BananaCMS 云转码功能方案

> 创建时间：2026-01-01
> 状态：待开发

## 一、功能概述

实现视频上传、转码切片、加密防盗的完整流程，让站长可以自建视频资源。

### 核心需求
- 上传视频文件（MP4/AVI/MKV等）
- 自动转码为 HLS (m3u8 + ts)
- 切片加密，防止被下载合并
- 文件名混淆，防止按序号抓取

## 二、技术方案

### 2.1 技术栈

| 组件 | 说明 | 必需 |
|------|------|------|
| FFmpeg | 视频转码核心工具 | ✅ 必须安装 |
| PHP-FFMpeg | PHP 调用 FFmpeg 的库 | 可选（也可直接 exec） |
| OpenSSL | AES 加密 | PHP 自带 |

### 2.2 防盗策略

#### 方案一：AES-128 加密（推荐）
```bash
# FFmpeg 切片 + AES 加密命令
ffmpeg -i input.mp4 \
  -c:v libx264 -c:a aac \
  -hls_time 10 \
  -hls_key_info_file key_info.txt \
  -hls_segment_filename 'segment_%03d.ts' \
  -hls_playlist_type vod \
  output.m3u8
```

key_info.txt 格式：
```
https://example.com/api/key/abc123  # key 获取地址
/path/to/encrypt.key                 # 本地 key 文件
iv（可选）                            # 初始化向量
```

#### 方案二：文件名混淆
```php
// 生成随机文件名
$segments = [];
for ($i = 0; $i < $count; $i++) {
    $segments[] = bin2hex(random_bytes(8)) . '.ts';
}
// 结果：a7f3b2c1d9e4f5a6.ts, x9k4m8n2p3q1r7s5.ts ...
```

#### 方案三：动态 m3u8 + 签名
```php
// 每个 ts 地址带时效签名
$sign = md5($tsFile . $time . $secret);
$url = "/play/{$tsFile}?t={$time}&sign={$sign}";
```

### 2.3 完整流程

```
用户上传视频
    ↓
写入转码队列（数据库）
    ↓
定时任务/后台进程处理队列
    ↓
FFmpeg 转码切片
    ↓
生成加密 key
    ↓
AES 加密每个 ts 文件
    ↓
生成 m3u8 索引
    ↓
存储到本地/R2
    ↓
更新视频播放地址
```

## 三、数据库设计

### 3.1 转码任务表 xpk_transcode
```sql
CREATE TABLE `xpk_transcode` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `vod_id` int(10) unsigned DEFAULT 0 COMMENT '关联视频ID',
  `source_file` varchar(500) NOT NULL COMMENT '源文件路径',
  `output_dir` varchar(500) NOT NULL COMMENT '输出目录',
  `status` tinyint(1) NOT NULL DEFAULT 0 COMMENT '状态:0待处理,1处理中,2完成,3失败',
  `progress` tinyint(3) unsigned DEFAULT 0 COMMENT '进度百分比',
  `duration` int(10) unsigned DEFAULT 0 COMMENT '视频时长(秒)',
  `resolution` varchar(20) DEFAULT '' COMMENT '分辨率',
  `bitrate` varchar(20) DEFAULT '' COMMENT '码率',
  `encrypt_key` varchar(64) DEFAULT '' COMMENT '加密密钥',
  `m3u8_url` varchar(500) DEFAULT '' COMMENT '生成的m3u8地址',
  `error_msg` varchar(500) DEFAULT '' COMMENT '错误信息',
  `created_at` int(10) unsigned DEFAULT 0,
  `updated_at` int(10) unsigned DEFAULT 0,
  `finished_at` int(10) unsigned DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `vod_id` (`vod_id`),
  KEY `status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='转码任务表';
```

## 四、核心代码设计

### 4.1 转码器类 core/Transcoder.php
```php
<?php
class XpkTranscoder
{
    private string $ffmpeg = 'ffmpeg';
    private string $ffprobe = 'ffprobe';
    
    /**
     * 获取视频信息
     */
    public function getVideoInfo(string $file): array
    {
        $cmd = "{$this->ffprobe} -v quiet -print_format json -show_format -show_streams {$file}";
        exec($cmd, $output);
        return json_decode(implode('', $output), true);
    }
    
    /**
     * 转码为 HLS
     */
    public function transcodeToHLS(string $input, string $outputDir, array $options = []): bool
    {
        $segmentTime = $options['segment_time'] ?? 10;
        $encrypt = $options['encrypt'] ?? true;
        
        // 创建输出目录
        if (!is_dir($outputDir)) {
            mkdir($outputDir, 0755, true);
        }
        
        // 生成加密 key
        $keyFile = $outputDir . '/encrypt.key';
        $keyInfo = $outputDir . '/key_info.txt';
        if ($encrypt) {
            $key = random_bytes(16);
            file_put_contents($keyFile, $key);
            
            $keyUrl = $options['key_url'] ?? '/api/transcode/key';
            file_put_contents($keyInfo, "{$keyUrl}\n{$keyFile}");
        }
        
        // 构建 FFmpeg 命令
        $cmd = "{$this->ffmpeg} -i {$input} ";
        $cmd .= "-c:v libx264 -c:a aac ";
        $cmd .= "-hls_time {$segmentTime} ";
        $cmd .= "-hls_segment_filename '{$outputDir}/%08x.ts' "; // 随机文件名
        $cmd .= "-hls_playlist_type vod ";
        
        if ($encrypt) {
            $cmd .= "-hls_key_info_file {$keyInfo} ";
        }
        
        $cmd .= "{$outputDir}/index.m3u8 2>&1";
        
        exec($cmd, $output, $returnCode);
        
        return $returnCode === 0;
    }
}
```

### 4.2 转码控制器 controllers/admin/TranscodeController.php
```php
<?php
class AdminTranscodeController extends AdminBaseController
{
    /**
     * 转码任务列表
     */
    public function index(): void
    {
        // 获取任务列表
        $tasks = $this->db->query(
            "SELECT * FROM " . DB_PREFIX . "transcode ORDER BY id DESC LIMIT 50"
        );
        $this->assign('tasks', $tasks);
        $this->display('transcode/index');
    }
    
    /**
     * 上传视频
     */
    public function upload(): void
    {
        // 处理文件上传
        // 创建转码任务
    }
    
    /**
     * 执行转码（定时任务调用）
     */
    public function process(): void
    {
        // 获取待处理任务
        // 调用 Transcoder 转码
        // 更新任务状态
    }
    
    /**
     * 获取加密 key（播放器请求）
     */
    public function key(): void
    {
        // 验证请求合法性（token/referer）
        // 返回 key 内容
    }
}
```

### 4.3 定时任务 cron_transcode.php
```php
<?php
/**
 * 转码定时任务
 * Crontab: * * * * * php /www/site/cron_transcode.php
 */

require_once __DIR__ . '/config/config.php';
require_once CORE_PATH . 'Database.php';
require_once CORE_PATH . 'Transcoder.php';

$db = XpkDatabase::getInstance();
$transcoder = new XpkTranscoder();

// 获取一个待处理任务
$task = $db->queryOne(
    "SELECT * FROM " . DB_PREFIX . "transcode WHERE status = 0 ORDER BY id ASC LIMIT 1"
);

if (!$task) {
    exit('No task');
}

// 更新状态为处理中
$db->execute(
    "UPDATE " . DB_PREFIX . "transcode SET status = 1, updated_at = ? WHERE id = ?",
    [time(), $task['id']]
);

// 执行转码
$success = $transcoder->transcodeToHLS($task['source_file'], $task['output_dir']);

// 更新结果
$db->execute(
    "UPDATE " . DB_PREFIX . "transcode SET status = ?, finished_at = ? WHERE id = ?",
    [$success ? 2 : 3, time(), $task['id']]
);
```

## 五、服务器配置

### 5.1 安装 FFmpeg

**CentOS/RHEL:**
```bash
yum install epel-release
yum install ffmpeg ffmpeg-devel
```

**Ubuntu/Debian:**
```bash
apt update
apt install ffmpeg
```

**宝塔面板:**
软件商店 → 搜索 "FFmpeg" → 安装

**验证安装:**
```bash
ffmpeg -version
ffprobe -version
```

### 5.2 PHP 配置
```ini
; php.ini
max_execution_time = 0      ; 转码可能很久
memory_limit = 512M         ; 大文件需要更多内存
upload_max_filesize = 2G    ; 允许上传大文件
post_max_size = 2G
```

### 5.3 Nginx 配置
```nginx
# 允许大文件上传
client_max_body_size 2G;

# m3u8 和 ts 文件的 MIME 类型
types {
    application/vnd.apple.mpegurl m3u8;
    video/mp2t ts;
}

# 防盗链（可选）
location ~ \.(ts|key)$ {
    valid_referers none blocked server_names *.yourdomain.com;
    if ($invalid_referer) {
        return 403;
    }
}
```

## 六、开发计划

### 第一阶段：基础功能（1周）
- [ ] 数据库表创建
- [ ] 视频上传功能
- [ ] FFmpeg 基础切片
- [ ] 后台任务列表

### 第二阶段：加密防盗（1周）
- [ ] AES-128 加密
- [ ] 文件名混淆
- [ ] Key 动态获取接口
- [ ] 防盗链验证

### 第三阶段：完善优化（1周）
- [ ] 转码进度显示
- [ ] 多码率转码
- [ ] 队列管理
- [ ] 错误重试机制

## 七、替代方案

如果不想自建转码服务，可以使用云服务：

| 服务商 | 产品 | 价格参考 |
|--------|------|----------|
| 阿里云 | 媒体处理 MPS | 约 0.02 元/分钟 |
| 腾讯云 | 媒体处理 MPS | 约 0.02 元/分钟 |
| 七牛云 | 智能多媒体 | 约 0.015 元/分钟 |
| 又拍云 | 云处理 | 约 0.01 元/分钟 |

云服务优势：
- 无需服务器安装 FFmpeg
- 自动扩容，不占用服务器资源
- 支持更多格式和功能
- 自带 CDN 加速

## 八、参考资料

- [FFmpeg 官方文档](https://ffmpeg.org/documentation.html)
- [HLS 协议规范](https://datatracker.ietf.org/doc/html/rfc8216)
- [PHP-FFMpeg GitHub](https://github.com/PHP-FFMpeg/PHP-FFMpeg)
- [AES-128 加密说明](https://en.wikipedia.org/wiki/Advanced_Encryption_Standard)
